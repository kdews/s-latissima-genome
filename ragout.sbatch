#!/bin/bash
#SBATCH -J ragout
#SBATCH -p htcondor
#SBATCH --mem=15gb
#SBATCH --time=05:00:00
#SBATCH --cpus-per-task=12
#SBATCH -o %x.log

# Initialize script
init="s-latissima-genome/script_init.sh"
if [[ -a "$init" ]]; then source "$init"; else { echo "Init err"; exit 1; }; fi

# Script environment variables
R_mod_file="modules_for_Rscript.txt"
r_script="${job_name}.R"
ragout_dir="ragout-out"

# Help message
if [[ $1 == "-h" ]] || [[ $1 == "--help" ]]
then
  echo "\
Runs Ragout in large assembly mode on HAL file generated by Cactus.
Usage: sbatch ${SLURM_JOB_NAME}.sbatch <recipe_file> <assembly_file> [ragout_dir]
Requires: Ragout (https://github.com/fenderglass/Ragout)"
  exit 0
fi

# Prepend scripts directory to variables
R_mod_file="${scripts_dir}${R_mod_file}"
r_script="${scripts_dir}${r_script}"

# Take recipe file and assembly file as input
# Defaults
recipe_file="${scripts_dir}s_lat_rag.rcp"
assembly_file="${scripts_dir}species_table.txt"
[[ -n "$1" ]] && recipe_file="$1"
[[ -n "$2" ]] && assembly_file="$2"
[[ -n "$3" ]] && ragout_dir="$3"

# Load Python module and Cactus virtualenv
module purge
module load gcc/12.3.0 python/3.11.4 git/2.42.0 py-pip/23.0
env_path="/home1/kdeweese/bin/cactus-bin-v2.6.7/cactus_env/bin/activate"
if [[ -a "$env_path" ]]
then
  source "$env_path"
else
  echo "Error on source of $env_path"
  exit 1
fi
# Load Ragout conda env
conda activate ragout
echo "Ragout version: $(ragout --version)"

# Run Ragout
if [[ -f "$recipe_file" ]]
then
  echo "Using recipe file $recipe_file"
else
  echo "Error: recipe file ($recipe_file) not found."
fi
# cmd="ragout -s maf -t $SLURM_CPUS_PER_TASK -o $ragout_dir $recipe_file"
# cmd="ragout --refine -s maf -t $SLURM_CPUS_PER_TASK -o $ragout_dir $recipe_file"
cmd="ragout --solid-scaffolds --refine -s maf -t $SLURM_CPUS_PER_TASK -o $ragout_dir $recipe_file"
echo "$cmd"
$cmd
# Clear env
conda deactivate
deactivate
module purge

# Index Ragout output FASTA files
mapfile -t fastas < <(ls "${ragout_dir}"/*.fasta)
conda activate samtools
samtools --version | head -n1
# Index assemblies
for fasta in "${fastas[@]}"
do
    if [[ -f "${fasta}.fai" ]]
    then
        echo "Found file ${fasta}.fai, skipping samtools faidx step."
    else
        cmd="samtools faidx $fasta"
        echo "$cmd"
        $cmd
    fi
done
conda deactivate

# Load R modules
module purge
IFS=" " read -r -a R_mods <<< "$(cat "$R_mod_file")"
module load "${R_mods[@]}"

# Anaylze Ragout scaffolds with R
cmd="Rscript $r_script $assembly_file $ragout_dir Saccharina_latissima $scripts_dir"
echo "$cmd"
# $cmd


